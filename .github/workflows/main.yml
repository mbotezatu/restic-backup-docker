# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json
name: "Main"

on:
  push:
    branches: [ "*" ]
    tags: [ "*" ]
  pull_request:
    branches: [ "*" ]
  workflow_dispatch:

jobs:
  build-and-push-docker-image:
    name: "Build and Push Docker Image"
    runs-on: "ubuntu-latest"
    permissions:
      contents: "read"
      packages: "write"
    steps:
      - name: "Checkout Repository"
        uses: "actions/checkout@v5"

      - name: "Set up Docker Buildx"
        uses: "docker/setup-buildx-action@v3"

      - name: "Log in to Docker Hub"
        if: github.event_name != 'pull_request'
        uses: "docker/login-action@v3"
        with:
          registry: "docker.io"
          username: "${{ secrets.DOCKERHUB_USERNAME }}"
          password: "${{ secrets.DOCKERHUB_PASSWORD }}"
      
      - name: "Log in to GitHub Container Registry"
        if: github.event_name != 'pull_request'
        uses: "docker/login-action@v3"
        with:
          registry: "ghcr.io"
          username: "${{ github.actor }}"
          password: "${{ secrets.GITHUB_TOKEN }}"

      - name: "Extract Docker metadata"
        id: "docker_metadata"
        uses: "docker/metadata-action@v5"
        with:
          images: |
            docker.io/${{ github.repository_owner }}/restic-backup
            ghcr.io/${{ github.repository_owner }}/restic-backup
          tags: |
            type=ref,event=branch
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}

      - name: "Build and Push"
        uses: "docker/build-push-action@v5"
        with:
          context: "."
          push: "${{ github.event_name != 'pull_request' }}"
          tags: ${{ steps.docker_metadata.outputs.tags }}
          labels: ${{ steps.docker_metadata.outputs.labels }}
          attests: "type=provenance,mode=max,type=sbom"
